============================================================================
MEMORY LEAK - THIRD INVESTIGATION PASS - ROOT CAUSE FOUND
============================================================================

SMOKING GUN: @lru_cache on get_engine() in src/issue_tracker/cli/dependencies.py

THE LEAK MECHANISM:
============================================================================

1. integration_cli_runner fixture used by 29 tests
2. Each test creates NEW workspace with NEW database path
3. Each test runs CLI commands (create, list, update, etc.)
4. Commands call get_issue_service() → get_engine()
5. get_engine() is @lru_cache decorated
6. First test: engine created and CACHED
7. Test ends: workspace deleted, but engine STILL IN CACHE
8. Next test: new workspace, but get_engine() returns OLD cached engine!
9. OLD ENGINE NEVER DISPOSED = MEMORY LEAK
10. Repeat for all 29 tests = 29 LEAKED ENGINES

LEAK CALCULATION (ALL THREE PASSES):
============================================================================

Source 1: integration_cli_runner @lru_cache
  - 29 tests × 5MB/engine = 145MB

Source 2: CLI init command (no disposal)  
  - 29 tests × 5MB = 145MB

Source 3: Daemon periodic sync (no disposal)
  - 16 tests × 5 calls × 5MB = 400MB

Source 4: Test fixtures (no disposal)
  - Various fixtures = 100MB

TOTAL: ~790MB leaked (causes OOM on 2GB Linux systems)

THE FIX (Pass 3):
============================================================================

File: tests/conftest.py (lines 814-826)

Added to integration_cli_runner fixture cleanup:

    # Dispose cached engine BEFORE clearing cache
    try:
        cached_engine = get_engine()
        if cached_engine:
            cached_engine.dispose()
    except:
        pass
    
    # Clear all lru_caches
    get_engine.cache_clear()
    get_db_url.cache_clear()
    get_issues_folder.cache_clear()

WHY THREE PASSES WERE NEEDED:
============================================================================

Pass 1: Fixed obvious test fixture leaks (100MB)
Pass 2: Fixed production code leaks in init + daemon (545MB)  
Pass 3: Found HIDDEN leak in lru_cache (145MB)

The cache leak was hardest to find because:
- Hidden behind dependency injection
- Cache seems harmless but leaks resources
- Each test changes environment but cache doesn't know
- Platform-specific (Windows masks it)

ALL FILES MODIFIED:
============================================================================

Pass 3 (THIS):
  ✓ tests/conftest.py - integration_cli_runner cleanup

Pass 2:
  ✓ src/issue_tracker/cli/app.py - init command disposal
  ✓ src/issue_tracker/daemon/service.py - periodic sync disposal

Pass 1:
  ✓ tests/integration/conftest.py - fixture disposal
  ✓ tests/integration/test_daemon_integration.py - 4 locations

VERIFICATION:
============================================================================

All files import successfully ✓

Run: uv run scripts/build.py --verbose --integration all

Expected: 
- Memory: <150MB constant
- File descriptors: <200
- Tests: ALL PASS
- NO OOM ERRORS

Monitor with:
  watch -n 1 'free -m'

============================================================================
STATUS: READY FOR USER TESTING ON LINUX
============================================================================
