name: Pre-Release Testing

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build-test:
    name: Build and Test Package
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.12"]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Initiate environment
        run: uv venv

      - name: Build package
        run: uv tool run --from build pyproject-build
      
      - name: List built packages (Unix)
        if: runner.os != 'Windows'
        run: ls -lh dist/
      
      - name: List built packages (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: ls -lh dist/

      - name: Create test environment
        run: uv venv test-env
          
      - name: Install built package (Unix)
        if: ${{ runner.os != 'Windows' }}
        run: |
          uv pip install --python test-env/bin/python dist/*.whl

      - name: Install built package (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          uv pip install --python test-env/Scripts/python.exe dist/*.whl

      - name: Initialize agent (Unix)
        if: ${{ runner.os != 'Windows' }}
        run: |
          test-env/bin/agent init

      - name: Initialize agent (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          test-env/Scripts/agent init

      - name: Test CLI works (Unix)
        if: ${{ runner.os != 'Windows' }}
        run: |
          test-env/bin/agent --help
          test-env/bin/agent version
          test-env/bin/agent skills list

      - name: Test CLI works (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          test-env/Scripts/agent --help
          test-env/Scripts/agent version
          test-env/Scripts/agent skills list

      - name: Verify skills folder included
        if: ${{ runner.os == 'Linux' }}
        run: |
          python -m zipfile -l dist/*.whl | grep "skills/" | wc -l
          echo "✓ Skills folder verified in package"

  fresh-install:
    name: Fresh Install Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build package
        run: uv tool run --from build pyproject-build

      - name: Create completely fresh environment
        run: uv venv /tmp/fresh-install

      - name: Install package in fresh environment
        run: |
          uv pip install --python /tmp/fresh-install/bin/python dist/*.whl

      - name: Initialize agent
        run: |
          /tmp/fresh-install/bin/agent init

      - name: Test basic functionality
        run: |
          /tmp/fresh-install/bin/agent --help
          /tmp/fresh-install/bin/agent version
          /tmp/fresh-install/bin/agent init --help
          echo "✓ Fresh install successful"

      - name: Test skill discovery
        run: |
          /tmp/fresh-install/bin/agent skills list
          echo "✓ Skill discovery works"

  skill-installation:
    name: Test Skill Installation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build and install main package
        run: |
          uv tool run --from build pyproject-build
          uv venv /tmp/skill-test
          uv pip install --python /tmp/skill-test/bin/python dist/*.whl

      - name: Initialize agent
        run: |
          /tmp/skill-test/bin/agent init

      - name: Find skills path
        run: |
          SKILLS_PATH=$(/tmp/skill-test/bin/python -c "import glorious_agents; import os; print(os.path.join(os.path.dirname(glorious_agents.__file__), 'skills'))")
          echo "SKILLS_PATH=$SKILLS_PATH" >> $GITHUB_ENV
          echo "Skills path: $SKILLS_PATH"

      - name: Install a skill from bundled source
        run: |
          uv pip install --python /tmp/skill-test/bin/python -e ${{ env.SKILLS_PATH }}/notes

      - name: Verify skill loads
        run: |
          /tmp/skill-test/bin/agent skills list | grep notes
          /tmp/skill-test/bin/agent notes --help
          echo "✓ Skill installation successful"

  package-metadata:
    name: Verify Package Metadata
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build package
        run: uv tool run --from build pyproject-build

      - name: Extract and verify metadata
        run: |
          unzip -q dist/*.whl glorious_agents-*.dist-info/METADATA -d /tmp/
          echo "=== Package Metadata ==="
          cat /tmp/glorious_agents-*.dist-info/METADATA | head -30
          
          # Verify author
          grep "Thomas Weholt" /tmp/glorious_agents-*.dist-info/METADATA || exit 1
          
          # Verify URLs
          grep "github.com/weholt/glorious-agents" /tmp/glorious_agents-*.dist-info/METADATA || exit 1
          
          # Verify license
          grep "MIT" /tmp/glorious_agents-*.dist-info/METADATA || exit 1
          
          echo "✓ All metadata verified"

  size-check:
    name: Package Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build package
        run: uv tool run --from build pyproject-build

      - name: Check package sizes
        run: |
          echo "=== Package Sizes ==="
          ls -lh dist/ || dir dist\
          
          WHEEL_SIZE=$(stat -f%z dist/*.whl 2>/dev/null || stat -c%s dist/*.whl)
          SDIST_SIZE=$(stat -f%z dist/*.tar.gz 2>/dev/null || stat -c%s dist/*.tar.gz)
          
          echo "Wheel size: $WHEEL_SIZE bytes"
          echo "Source dist size: $SDIST_SIZE bytes"
          
          # Warn if wheel is over 5MB
          if [ "$WHEEL_SIZE" -gt 5242880 ]; then
            echo "⚠️  Warning: Wheel is larger than 5MB"
          else
            echo "✓ Wheel size is reasonable"
          fi
